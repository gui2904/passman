#!/usr/bin/env python3

import json
import string
import secrets
import argparse
from cryptography.fernet import Fernet
from pathlib import Path

# Defining Paths
APP_DIR = Path.home() / ".config" / "passman"
KEY_FILE = APP_DIR / "secret.key"
CREDENTIALS_FILE = APP_DIR / "credentials.json"

def ensure_app_dir():
    APP_DIR.mkdir(mode=0o700, parents=True, exist_ok=True)

# Function to generate random pass
def generate_password(
    length: int = 16,
    use_lower: bool = True,
    use_upper: bool = True,
    use_digits: bool = True,
    use_special: bool = True,

    ) -> str:
    if length < 4:
        raise ValueError("Password length must be at least 4")

    pools = []
    guaranteed = []

    if use_lower:
        pools.append(string.ascii_lowercase)
        guaranteed.append(secrets.choice(string.ascii_lowercase))
    if use_upper:
        pools.append(string.ascii_uppercase)
        guaranteed.append(secrets.choice(string.ascii_uppercase))
    if use_digits:
        pools.append(string.digits)
        guaranteed.append(secrets.choice(string.digits))
    if use_special:
        pools.append(string.punctuation)
        guaranteed.append(secrets.choice(string.punctuation))

    if not pools:
        raise ValueError("At least one character set must be enabled")

    pool = "".join(pools)
    remaining = length - len(guaranteed)

    password_chars = guaranteed + [
        secrets.choice(pool) for _ in range(remaining)
    ]

    secrets.SystemRandom().shuffle(password_chars)
    return "".join(password_chars)

# Encryption and Decryption Functions
def generate_key():
    return Fernet.generate_key()

def load_key():
    ensure_app_dir()
    if not KEY_FILE.exists():
        key = Fernet.generate_key()
        KEY_FILE.write_bytes(key)
        KEY_FILE.chmod(0o600)
    return KEY_FILE.read_bytes()

def save_key(key):
    with open("secret.key", "wb") as key_file:
        key_file.write(key)

def encrypt_message(message):
    key = load_key()
    f = Fernet(key)
    return f.encrypt(message.encode("utf-8")).decode("utf-8")

def decrypt_message(encrypted_message: str) -> str:
    key = load_key()
    f = Fernet(key)
    return f.decrypt(encrypted_message.encode("utf-8")).decode("utf-8")

# Password Manager Functions
def load_credentials():
    ensure_app_dir()
    if not CREDENTIALS_FILE.exists():
        return {}
    return json.loads(CREDENTIALS_FILE.read_text())

def save_credentials(credentials):
    ensure_app_dir()
    tmp = CREDENTIALS_FILE.with_suffix(".tmp")
    tmp.write_text(json.dumps(credentials))
    tmp.chmod(0o600)
    tmp.replace(CREDENTIALS_FILE)

def add_credential(name, username, password, force=False):
    credentials = load_credentials()
    if name in credentials and not force:
        print(f"Credential '{name}' already exists. Use --force to overwrite.")
        return
    encrypted_password = encrypt_message(password)
    credentials[name] = {"username": username, "password": encrypted_password}
    save_credentials(credentials)
    print("Credential added successfully.")

def view_credentials(name):
    credentials = load_credentials()
    if name in credentials:
        user_info = credentials[name]
        decrypted_password = decrypt_message(user_info["password"])
        print(f"Name: {name}")
        print(f"Username: {user_info['username']}")
        print(f"Password: {decrypted_password}")
    else:
        print("Credential not found.")

def list_credentials():
    credentials = load_credentials()
    if not credentials:
        print("No credentials saved.")
        return
    for name in sorted(credentials.keys()):
        print(name)

def edit_credential(name, new_username=None, new_password=None):
    credentials = load_credentials()
    if name in credentials:
        if new_username:
            credentials[name]["username"] = new_username
        if new_password:
            credentials[name]["password"] = encrypt_message(new_password)
        save_credentials(credentials)
        print("Credential updated successfully.")
    else:
        print("Credential not found.")

def rename_credential(old_name, new_name, force=False):
    credentials = load_credentials()
    if old_name not in credentials:
        print("Credential not found.")
        return
    if new_name in credentials and not force:
        print(f"'{new_name}' already exists. Use --force to overwrite.")
        return
    credentials[new_name] = credentials.pop(old_name)
    save_credentials(credentials)
    print("Credential renamed successfully.")

def delete_credentials(name, yes=False):
    credentials = load_credentials()
    if name not in credentials:
        print("Credential not found.")
        return
    if not yes:
        confirm = input(f"Delete '{name}'? (y/N): ").strip().lower()
        if confirm != "y":
            print("Cancelled.")
            return
    del credentials[name]
    save_credentials(credentials)
    print("Credential deleted successfully.")

# Command-Line Interface
def main():
    parser = argparse.ArgumentParser(description="Simple Password Manager")
    parser.add_argument("command", choices=["add", "view", "edit", "list", "delete", "rename"], help="Command to run")
    parser.add_argument("name", nargs="?",help="Name of the credential")
    parser.add_argument("--new-name", help="New name for rename")
    parser.add_argument("--username", help="Username for the credential")
    parser.add_argument("--password", help="Password for the credential")
    parser.add_argument("--force", action="store_true", help="Overwrite if destination exists")
    parser.add_argument("--yes", action="store_true", help="Assume yes (delete without prompt)")
    parser.add_argument("--length", type=int, default=16, help="Generated password length") 
    args = parser.parse_args()

    if args.command == "list":
        list_credentials()

    elif args.command == "add":
        if not args.name or not args.username:
            print("Name and --username are required to add a credential.")
            return
        password = args.password or generate_password(length=args.length)
        if not password:
            print("Failed to add credential: password could not be generated.")
            return
        add_credential(args.name, args.username, password, force=args.force)

    elif args.command == "view":
        if not args.name:
            print("Name is required for view.")
            return
        view_credentials(args.name)

    elif args.command == "edit":
        if not args.name:
            print("Name is required for edit.")
            return
        edit_credential(args.name, args.username, args.password)

    elif args.command == "delete":
        if not args.name:
            print("Name is required for delete.")
            return
        delete_credentials(args.name, yes=args.yes)

    elif args.command == "rename":
        if not args.name or not args.new_name:
            print("Rename requires: old name and --new-name")
            return
        rename_credential(args.name, args.new_name, force=args.force)

if __name__ == "__main__":
    main()
